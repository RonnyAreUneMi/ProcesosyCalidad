{% extends 'base.html' %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900 py-8">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">
                        <i class="fas fa-plus-circle text-sky-600 mr-2"></i>
                        Crear Nuevo Destino
                    </h1>
                    <p class="text-gray-600 dark:text-gray-300">Completa la información del destino turístico</p>
                </div>
                <a href="{% url 'destinos:lista_destinos' %}" 
                   class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 dark:bg-gray-900 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Volver
                </a>
            </div>
        </div>

        <!-- Form -->
        <form method="post" enctype="multipart/form-data" class="space-y-6">
            {% csrf_token %}

            <!-- Información Básica -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
                    <div class="w-8 h-8 bg-sky-100 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-info-circle text-sky-600"></i>
                    </div>
                    Información Básica
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Nombre -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                            Nombre del Destino <span class="text-red-500">*</span>
                        </label>
                        <input type="text"
                               name="nombre"
                               required
                               class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-all"
                               placeholder="Ej: Montañita, Baños de Agua Santa">
                    </div>

                    <!-- Región -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                            Región <span class="text-red-500">*</span>
                        </label>
                        <select name="region"
                                required
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-all">
                            <option value="">Selecciona una región</option>
                            {% for value, label in regiones %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Categoría -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                            Categoría
                        </label>
                        <select name="categoria"
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-all">
                            <option value="">Selecciona una categoría</option>
                            {% for categoria in categorias %}
                            <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Provincia -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                            Provincia <span class="text-red-500">*</span>
                        </label>
                        <select name="provincia"
                                id="provincia"
                                required
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-all">
                            <option value="">Selecciona una provincia</option>
                            {% for provincia in provincias %}
                            <option value="{{ provincia }}">{{ provincia }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Ciudad/Cantón -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                            Ciudad / Cantón
                        </label>
                        <select name="ciudad" 
                                id="ciudad"
                                class="text-gray-900 dark:text-white bg-white dark:bg-gray-700 w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-all"
                                disabled>
                            <option value="">Primero selecciona una provincia</option>
                        </select>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Selecciona primero la provincia</p>
                    </div>

                    <!-- Descripción Corta -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                            Descripción Corta <span class="text-red-500">*</span>
                        </label>
                        <input type="text" 
                               name="descripcion_corta" 
                               id="descripcion_corta"
                               required
                               maxlength="300"
                               class="text-gray-900 dark:text-white bg-white dark:bg-gray-700 w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-all placeholder-gray-500 dark:placeholder-gray-400"
                               placeholder="Resumen breve (máx. 300 caracteres)">
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                            <span id="charCount">0</span> / 300 caracteres
                        </p>
                    </div>

                    <!-- Descripción Completa -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                            Descripción Completa <span class="text-red-500">*</span>
                        </label>
                        <textarea name="descripcion" 
                                  required
                                  rows="6"
                                  class="text-gray-900 dark:text-white bg-white dark:bg-gray-700 w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-all placeholder-gray-500 dark:placeholder-gray-400"
                                  placeholder="Descripción detallada del destino..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Ubicación -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
                    <div class="w-8 h-8 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-map-marker-alt text-green-600"></i>
                    </div>
                    Ubicación Geográfica
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Latitud -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                            Latitud <span class="text-red-500">*</span>
                        </label>
                        <input type="number" 
                               name="latitud" 
                               required
                               step="0.0000001"
                               min="-90"
                               max="90"
                               class="text-gray-900 dark:text-white bg-white dark:bg-gray-700 w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-all placeholder-gray-500 dark:placeholder-gray-400"
                               placeholder="Ej: -2.1894">
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Coordenada geográfica (decimal)</p>
                    </div>

                    <!-- Longitud -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                            Longitud <span class="text-red-500">*</span>
                        </label>
                        <input type="number" 
                               name="longitud" 
                               required
                               step="0.0000001"
                               min="-180"
                               max="180"
                               class="text-gray-900 dark:text-white bg-white dark:bg-gray-700 w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-all placeholder-gray-500 dark:placeholder-gray-400"
                               placeholder="Ej: -79.8843">
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Coordenada geográfica (decimal)</p>
                    </div>

                    <!-- Altitud -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                            Altitud (msnm)
                        </label>
                        <input type="number" 
                               name="altitud" 
                               class="text-gray-900 dark:text-white bg-white dark:bg-gray-700 w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-all placeholder-gray-500 dark:placeholder-gray-400"
                               placeholder="Ej: 2850">
                    </div>

                    <!-- Clima -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                            Clima
                        </label>
                        <input type="text" 
                               name="clima" 
                               class="text-gray-900 dark:text-white bg-white dark:bg-gray-700 w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-all placeholder-gray-500 dark:placeholder-gray-400"
                               placeholder="Ej: Tropical húmedo">
                    </div>

                    <!-- Mejor Época -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                            Mejor Época para Visitar
                        </label>
                        <input type="text" 
                               name="mejor_epoca" 
                               class="text-gray-900 dark:text-white bg-white dark:bg-gray-700 w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-all placeholder-gray-500 dark:placeholder-gray-400"
                               placeholder="Ej: Junio a Septiembre">
                    </div>
                </div>
            </div>

            <!-- Precios -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
                    <div class="w-8 h-8 bg-yellow-100 dark:bg-yellow-900 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-dollar-sign text-yellow-600"></i>
                    </div>
                    Información de Precios
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Precio Mínimo -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                            Precio Promedio Mínimo (USD) <span class="text-red-500">*</span>
                        </label>
                        <input type="number" 
                               name="precio_promedio_minimo" 
                               required
                               step="0.01"
                               min="0"
                               class="text-gray-900 dark:text-white bg-white dark:bg-gray-700 w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-all placeholder-gray-500 dark:placeholder-gray-400"
                               placeholder="Ej: 50.00">
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Costo mínimo por persona por día</p>
                    </div>

                    <!-- Precio Máximo -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                            Precio Promedio Máximo (USD) <span class="text-red-500">*</span>
                        </label>
                        <input type="number" 
                               name="precio_promedio_maximo" 
                               required
                               step="0.01"
                               min="0"
                               class="text-gray-900 dark:text-white bg-white dark:bg-gray-700 w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-all placeholder-gray-500 dark:placeholder-gray-400"
                               placeholder="Ej: 150.00">
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Costo máximo por persona por día</p>
                    </div>
                </div>
            </div>

            <!-- Opciones Adicionales -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
                    <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-cog text-purple-600"></i>
                    </div>
                    Opciones Adicionales
                </h2>
                
                <div class="space-y-4">
                    <!-- Destacado -->
                    <div class="flex items-center">
                        <input type="checkbox" 
                               name="destacado" 
                               id="destacado"
                               class="text-gray-900 dark:text-white bg-white dark:bg-gray-700 w-5 h-5 text-sky-600 border-gray-300 dark:border-gray-600 rounded focus:ring-sky-500">
                        <label for="destacado" class="ml-3 text-sm font-medium text-gray-700 dark:text-gray-300">
                            Marcar como destino destacado
                        </label>
                    </div>

                    <!-- Activo -->
                    <div class="flex items-center">
                        <input type="checkbox" 
                               name="activo" 
                               id="activo"
                               checked
                               class="text-gray-900 dark:text-white bg-white dark:bg-gray-700 w-5 h-5 text-sky-600 border-gray-300 dark:border-gray-600 rounded focus:ring-sky-500">
                        <label for="activo" class="ml-3 text-sm font-medium text-gray-700 dark:text-gray-300">
                            Destino activo (visible públicamente)
                        </label>
                    </div>
                </div>
            </div>

            <!-- Imagen Principal -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
                    <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-image text-blue-600"></i>
                    </div>
                    Imagen Principal
                </h2>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        Subir Imagen
                    </label>
                    <input type="file" 
                           name="imagen_principal" 
                           accept="image/*"
                           id="imagen_principal"
                           class="text-gray-900 dark:text-white bg-white dark:bg-gray-700 w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-all">
                    <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                        Formatos aceptados: JPG, PNG, WEBP (máx. 5MB)
                    </p>
                    
                    <!-- Preview de imagen -->
                    <div id="imagePreviewContainer" class="mt-6">
                        <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">
                            Vista previa:
                        </p>
                        <div class="relative inline-block">
                            <img id="imagePreview" 
                                src="/static/images/destinos/destino_defecto.jpg" 
                                alt="Preview" 
                                class="w-64 h-48 object-cover rounded-lg shadow-md border-2 border-gray-200 dark:border-gray-700">
                            <div id="defaultBadge" class="absolute top-2 right-2 bg-blue-500 text-white text-xs font-semibold px-2 py-1 rounded-full shadow-md">
                                <i class="fas fa-image mr-1"></i>
                                Por defecto
                            </div>
                        </div>
                        <button type="button" 
                                id="removeImageBtn" 
                                class="hidden mt-3 px-4 py-2 bg-red-500 text-white text-sm font-medium rounded-lg hover:bg-red-600 transition-colors">
                            <i class="fas fa-times mr-2"></i>
                            Quitar imagen y usar por defecto
                        </button>
                    </div>
                </div>
            </div>

            <!-- Botones de Acción -->
            <div class="flex items-center justify-end space-x-4 pt-6">
                <a href="{% url 'destinos:lista_destinos' %}" 
                   class="px-6 py-3 border border-gray-300 rounded-lg font-semibold text-gray-700 hover:bg-gray-50 dark:bg-gray-900 transition-colors">
                    Cancelar
                </a>
                <button type="submit" 
                        class="px-6 py-3 bg-sky-600 text-white rounded-lg font-semibold hover:bg-sky-700 transition-colors shadow-lg hover:shadow-xl">
                    <i class="fas fa-save mr-2"></i>
                    Crear Destino
                </button>
            </div>
        </form>

    </div>
</div>

<script>
    // Preview de imagen mejorado con opción de remover
    document.addEventListener('DOMContentLoaded', function() {
        const imagenInput = document.getElementById('imagen_principal');
        const imagePreview = document.getElementById('imagePreview');
        const defaultBadge = document.getElementById('defaultBadge');
        const removeBtn = document.getElementById('removeImageBtn');
        const defaultImageUrl = '/static/images/destinos/destino_defecto.jpg';

        if (imagenInput) {
            imagenInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Validar tamaño
                    if (file.size > 5 * 1024 * 1024) {
                        alert('⚠️ La imagen no puede exceder 5MB');
                        this.value = '';
                        return;
                    }
                    
                    // Validar formato
                    const validFormats = ['image/jpeg', 'image/png', 'image/webp'];
                    if (!validFormats.includes(file.type)) {
                        alert('⚠️ Formato no válido. Usa JPG, PNG o WEBP');
                        this.value = '';
                        return;
                    }
                    
                    // Mostrar preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreview.src = e.target.result;
                        defaultBadge.classList.add('hidden');
                        removeBtn.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Botón para remover imagen y volver a la por defecto
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                imagenInput.value = '';
                imagePreview.src = defaultImageUrl;
                defaultBadge.classList.remove('hidden');
                removeBtn.classList.add('hidden');
            });
        }
    });
// Datos de provincias y cantones de Ecuador
const provinciasCantones = {{ provincias_cantones_json|safe }};

// Manejo de selección de provincia y cantón
document.getElementById('provincia').addEventListener('change', function() {
    const provincia = this.value;
    const ciudadSelect = document.getElementById('ciudad');
    
    // Limpiar opciones anteriores
    ciudadSelect.innerHTML = '<option value="">Selecciona un cantón</option>';
    
    if (provincia && provinciasCantones[provincia]) {
        // Habilitar el select de ciudad
        ciudadSelect.disabled = false;
        
        // Agregar las ciudades de la provincia seleccionada
        provinciasCantones[provincia].forEach(function(canton) {
            const option = document.createElement('option');
            option.value = canton;
            option.textContent = canton;
            ciudadSelect.appendChild(option);
        });
    } else {
        ciudadSelect.disabled = true;
        ciudadSelect.innerHTML = '<option value="">Primero selecciona una provincia</option>';
    }
});

// Contador de caracteres para descripción corta
document.getElementById('descripcion_corta').addEventListener('input', function() {
    const charCount = document.getElementById('charCount');
    charCount.textContent = this.value.length;
    
    if (this.value.length > 280) {
        charCount.classList.add('text-yellow-600');
    } else {
        charCount.classList.remove('text-yellow-600');
    }
    
    if (this.value.length >= 300) {
        charCount.classList.add('text-red-600');
        charCount.classList.remove('text-yellow-600');
    }
});

// Preview de imagen
document.getElementById('imagen_principal').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('preview').src = e.target.result;
            document.getElementById('imagePreview').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }
});
</script>
{% endblock %}