{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900">
    
    <!-- Header -->
    <div class="bg-gradient-to-r from-sky-600 to-blue-600 text-white py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <h1 class="text-4xl font-bold mb-3 flex items-center justify-center">
                    <i class="fas fa-map-marked-alt mr-3"></i>
                    Mapa de Destinos Tur√≠sticos
                </h1>
                <p class="text-xl text-sky-100">
                    Explora todos los destinos de Ecuador en un mapa interactivo
                </p>
            </div>
        </div>
    </div>

    <!-- Controles y Filtros -->
    <div class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-40 border-b border-gray-200 dark:border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex flex-wrap items-center justify-between gap-4">
                
                <!-- Bot√≥n Volver -->
                <a href="{% url 'destinos:lista_destinos' %}" 
                   class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 dark:bg-gray-900 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Volver a la lista
                </a>

                <!-- Filtros r√°pidos por regi√≥n -->
                <div class="flex flex-wrap gap-2">
                    <button onclick="filtrarPorRegion('todos')" 
                            class="region-filter-btn active px-4 py-2 rounded-lg font-semibold text-sm transition-all"
                            data-region="todos">
                        <i class="fas fa-globe-americas mr-1"></i>
                        Todos
                    </button>
                    <button onclick="filtrarPorRegion('costa')" 
                            class="region-filter-btn px-4 py-2 rounded-lg font-semibold text-sm transition-all"
                            data-region="costa">
                        <i class="fas fa-umbrella-beach mr-1"></i>
                        Costa
                    </button>
                    <button onclick="filtrarPorRegion('sierra')" 
                            class="region-filter-btn px-4 py-2 rounded-lg font-semibold text-sm transition-all"
                            data-region="sierra">
                        <i class="fas fa-mountain mr-1"></i>
                        Sierra
                    </button>
                    <button onclick="filtrarPorRegion('oriente')" 
                            class="region-filter-btn px-4 py-2 rounded-lg font-semibold text-sm transition-all"
                            data-region="oriente">
                        <i class="fas fa-tree mr-1"></i>
                        Oriente
                    </button>
                    <button onclick="filtrarPorRegion('galapagos')" 
                            class="region-filter-btn px-4 py-2 rounded-lg font-semibold text-sm transition-all"
                            data-region="galapagos">
                        <i class="fas fa-fish mr-1"></i>
                        Gal√°pagos
                    </button>
                </div>

                <!-- Contador de destinos -->
                <div class="text-sm font-semibold text-gray-700 dark:text-gray-300">
                    <i class="fas fa-map-pin text-sky-600 mr-1"></i>
                    <span id="destinosCount">0</span> destinos
                </div>
            </div>
        </div>
    </div>

    <!-- Contenedor centrado y limitado -->
   <div class="flex justify-center py-8">
    <div class="relative w-full max-w-5xl bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-visible" style="height: 600px; z-index: 0;">
        <!-- Mapa centrado -->
        <div class="flex justify-center items-center w-full h-full">
            <div id="map" class="w-full h-full"></div>
        </div>
        
        <!-- Loading overlay -->
        <div id="mapLoading" class="absolute inset-0 bg-white dark:bg-gray-800 bg-opacity-90 flex items-center justify-center z-10">
            <div class="text-center">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-sky-600 mb-4"></div>
                <p class="text-gray-600 dark:text-gray-300 font-semibold">Cargando mapa...</p>
            </div>
        </div>
    </div>
</div>



    

</div>

<!-- Estilos adicionales -->
<style>
    .region-filter-btn {
        background-color: #f3f4f6;
        color: #4b5563;
    }
    
    .region-filter-btn:hover {
        background-color: #e5e7eb;
    }
    
    .region-filter-btn.active {
        background-color: #0ea5e9;
        color: white;
    }

    /* Estilos para Mapbox popups */
    .mapboxgl-popup-content {
        border-radius: 12px;
        padding: 0;
        min-width: 250px;
    }
</style>

<!-- Mapbox GL JS -->
<script src='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css' rel='stylesheet' />

<!-- Ecuador Mapbox System -->
<script src="{% static 'js/ecuador-mapbox.js' %}"></script>
<script src="{% static 'js/map-controls.js' %}"></script>

<script>
let ecuadorMap, mapControls, destinosData = [];

try {
    destinosData = JSON.parse('{{ destinos_json|safe }}');
    console.log(`üìä ${destinosData.length} destinos cargados desde la base de datos`);
} catch (error) {
    console.error('‚ùå Error al parsear datos de destinos:', error);
    destinosData = [];
}

function filtrarPorRegion(region) {
    if (mapControls) {
        mapControls.filterByRegion(region);
    }
}

document.addEventListener('DOMContentLoaded', async function() {
    console.log('üöÄ P√°gina cargada, inicializando mapa...');
    
    if (destinosData.length === 0) {
        console.warn('‚ö†Ô∏è No hay destinos para mostrar');
        const loadingDiv = document.getElementById('mapLoading');
        loadingDiv.innerHTML = `
            <div class="text-center">
                <i class="fas fa-map-marked-alt text-gray-400 dark:text-gray-500 text-5xl mb-4"></i>
                <p class="text-gray-900 dark:text-white font-semibold mb-2">No hay destinos disponibles</p>
                <p class="text-gray-600 dark:text-gray-300 text-sm mb-4">Crea tu primer destino tur√≠stico</p>
                {% if user.is_authenticated and user.es_administrador %}
                <a href="{% url 'destinos:crear_destino' %}" class="inline-block px-6 py-3 bg-sky-600 text-white rounded-lg hover:bg-sky-700 font-semibold">
                    <i class="fas fa-plus mr-2"></i>
                    Crear destino
                </a>
                {% endif %}
            </div>
        `;
        return;
    }
    
    try {
        // Inicializar mapa
        ecuadorMap = new EcuadorMapbox('map', {
            enable3D: true
        });
        
        await ecuadorMap.init();
        
        // Crear marcadores
        ecuadorMap.createMarkersFromData(destinosData);
        
        // Actualizar contador
        document.getElementById('destinosCount').textContent = destinosData.length;
        
        setTimeout(() => {
            document.getElementById('mapLoading').classList.add('hidden');
            console.log('‚úÖ Mapa completamente cargado');
        }, 500);
        
    } catch (error) {
        console.error('‚ùå Error al inicializar el mapa:', error);
        const loadingDiv = document.getElementById('mapLoading');
        loadingDiv.innerHTML = `
            <div class="text-center">
                <i class="fas fa-exclamation-triangle text-red-600 text-4xl mb-4"></i>
                <p class="text-gray-900 dark:text-white font-semibold mb-2">Error al cargar el mapa</p>
                <p class="text-gray-600 dark:text-gray-300 text-sm">${error.message}</p>
                <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-sky-600 text-white rounded-lg hover:bg-sky-700">
                    Recargar p√°gina
                </button>
            </div>
        `;
    }
});
</script>

{% endblock %}
