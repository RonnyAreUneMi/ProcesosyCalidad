{% extends 'base.html' %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    
    <!-- Header -->
    <div class="bg-gradient-to-r from-sky-600 to-blue-600 text-white py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <h1 class="text-4xl font-bold mb-3 flex items-center justify-center">
                    <i class="fas fa-map-marked-alt mr-3"></i>
                    Mapa de Destinos Tur√≠sticos
                </h1>
                <p class="text-xl text-sky-100">
                    Explora todos los destinos de Ecuador en un mapa interactivo
                </p>
            </div>
        </div>
    </div>

    <!-- Controles y Filtros -->
    <div class="bg-white shadow-md sticky top-0 z-40 border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex flex-wrap items-center justify-between gap-4">
                
                <!-- Bot√≥n Volver -->
                <a href="{% url 'destinos:lista_destinos' %}" 
                   class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Volver a la lista
                </a>

                <!-- Filtros r√°pidos por regi√≥n -->
                <div class="flex flex-wrap gap-2">
                    <button onclick="filtrarPorRegion('todos')" 
                            class="region-filter-btn active px-4 py-2 rounded-lg font-semibold text-sm transition-all"
                            data-region="todos">
                        <i class="fas fa-globe-americas mr-1"></i>
                        Todos
                    </button>
                    <button onclick="filtrarPorRegion('costa')" 
                            class="region-filter-btn px-4 py-2 rounded-lg font-semibold text-sm transition-all"
                            data-region="costa">
                        <i class="fas fa-umbrella-beach mr-1"></i>
                        Costa
                    </button>
                    <button onclick="filtrarPorRegion('sierra')" 
                            class="region-filter-btn px-4 py-2 rounded-lg font-semibold text-sm transition-all"
                            data-region="sierra">
                        <i class="fas fa-mountain mr-1"></i>
                        Sierra
                    </button>
                    <button onclick="filtrarPorRegion('oriente')" 
                            class="region-filter-btn px-4 py-2 rounded-lg font-semibold text-sm transition-all"
                            data-region="oriente">
                        <i class="fas fa-tree mr-1"></i>
                        Oriente
                    </button>
                    <button onclick="filtrarPorRegion('galapagos')" 
                            class="region-filter-btn px-4 py-2 rounded-lg font-semibold text-sm transition-all"
                            data-region="galapagos">
                        <i class="fas fa-fish mr-1"></i>
                        Gal√°pagos
                    </button>
                </div>

                <!-- Contador de destinos -->
                <div class="text-sm font-semibold text-gray-700">
                    <i class="fas fa-map-pin text-sky-600 mr-1"></i>
                    <span id="destinosCount">0</span> destinos
                </div>
            </div>
        </div>
    </div>

    <!-- Contenedor centrado y limitado -->
   <div class="flex justify-center py-8">
    <div class="relative w-full max-w-5xl bg-white rounded-xl shadow-lg overflow-visible" style="height: 600px; z-index: 0;">
        <!-- Mapa centrado -->
        <div class="flex justify-center items-center w-full h-full">
            <div id="map" class="w-full h-full"></div>
        </div>
        
        <!-- Loading overlay -->
        <div id="mapLoading" class="absolute inset-0 bg-white bg-opacity-90 flex items-center justify-center z-10">
            <div class="text-center">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-sky-600 mb-4"></div>
                <p class="text-gray-600 font-semibold">Cargando mapa...</p>
            </div>
        </div>
    </div>
</div>



    

</div>

<!-- Estilos adicionales -->
<style>
    .region-filter-btn {
        background-color: #f3f4f6;
        color: #4b5563;
    }
    
    .region-filter-btn:hover {
        background-color: #e5e7eb;
    }
    
    .region-filter-btn.active {
        background-color: #0ea5e9;
        color: white;
    }

    /* Estilos para Leaflet popups */
    .leaflet-popup-content-wrapper {
        border-radius: 12px;
        padding: 0;
    }

    .leaflet-popup-content {
        margin: 0;
        min-width: 250px;
    }
</style>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
      crossorigin=""/>

<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<script>
    // ========================================
    // VARIABLES GLOBALES
    // ========================================
    let map = null;
    let markers = [];
    let markerLayer = null;
    let regionActual = 'todos';
    let destinosData = [];

    // ========================================
    // DATOS DE DESTINOS DESDE DJANGO
    // ========================================
    try {
        // Los datos ya vienen como JSON string desde el backend
        destinosData = JSON.parse('{{ destinos_json|safe }}');
        console.log(`üìä ${destinosData.length} destinos cargados desde la base de datos`);
        
        // Validar que hay datos
        if (!destinosData || destinosData.length === 0) {
            console.warn('‚ö†Ô∏è No hay destinos en la base de datos');
        }
    } catch (error) {
        console.error('‚ùå Error al parsear datos de destinos:', error);
        destinosData = [];
    }

    // ========================================
    // √çCONOS PERSONALIZADOS POR REGI√ìN
    // ========================================
    const regionIcons = {
        'costa': L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        }),
        'sierra': L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        }),
        'oriente': L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        }),
        'galapagos': L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        })
    };

    // ========================================
    // INICIALIZAR MAPA
    // ========================================
    function initMap() {
        try {
            console.log('üó∫Ô∏è Inicializando mapa...');
            
            // Centro de Ecuador
            const ecuadorCenter = [-1.8312, -78.1834];

            // Crear mapa
            map = L.map('map').setView(ecuadorCenter, 7);
            console.log('‚úÖ Mapa creado');

            // A√±adir capa de tiles (OpenStreetMap)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19,
                minZoom: 5
            }).addTo(map);
            console.log('‚úÖ Tiles a√±adidos');

            // Crear capa para los marcadores
            markerLayer = L.layerGroup().addTo(map);

            // Crear marcadores
            crearMarcadores();

            // Ocultar loading
            setTimeout(() => {
                document.getElementById('mapLoading').classList.add('hidden');
                console.log('‚úÖ Mapa completamente cargado');
            }, 500);

        } catch (error) {
            console.error('‚ùå Error al inicializar el mapa:', error);
            const loadingDiv = document.getElementById('mapLoading');
            loadingDiv.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle text-red-600 text-4xl mb-4"></i>
                    <p class="text-gray-900 font-semibold mb-2">Error al cargar el mapa</p>
                    <p class="text-gray-600 text-sm">${error.message}</p>
                    <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-sky-600 text-white rounded-lg hover:bg-sky-700">
                        Recargar p√°gina
                    </button>
                </div>
            `;
        }
    }


// CREAR MARCADORES
// ========================================
function crearMarcadores() {
    if (markerLayer) markerLayer.clearLayers();
    markers = [];

    const destinosFiltrados = regionActual === 'todos' 
        ? destinosData 
        : destinosData.filter(d => d.region === regionActual);

    const bounds = [];

    destinosFiltrados.forEach(destino => {
        const lat = parseFloat(destino.latitud);
        const lng = parseFloat(destino.longitud);
        if (isNaN(lat) || isNaN(lng)) return;

        const marker = L.marker([lat, lng], {
            icon: regionIcons[destino.region] || regionIcons['costa'],
            title: destino.nombre
        });

        // URL del mapa est√°tico de Google Maps
        const mapImageUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${lat},${lng}&zoom=15&size=120x80&maptype=roadmap&markers=color:red%7C${lat},${lng}&key=TU_API_KEY`;

        const popupContent = `
        <div style="padding: 12px; max-width: 250px;">
            <div style="display: flex; gap: 8px; align-items: flex-start;">
                <img src="${mapImageUrl}" 
                     alt="${destino.nombre}" 
                     style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;"/>
                <div style="flex: 1;">
                    <h4 style="font-weight: bold; font-size: 16px; margin-bottom: 4px; color: #1f2937;">
                        ${destino.nombre}
                    </h4>
                    <p style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">
                        ${destino.descripcion_corta || 'Sin descripci√≥n'}
                    </p>
                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
                        <span style="color: #f59e0b; font-size: 12px;">
                            ${'‚òÖ'.repeat(Math.round(destino.calificacion_promedio || 0))}${'‚òÜ'.repeat(5 - Math.round(destino.calificacion_promedio || 0))}
                        </span>
                        <span style="font-size: 10px; color: #6b7280;">
                            ${(destino.calificacion_promedio || 0).toFixed(1)}
                        </span>
                    </div>
                    <a href="/destinos/${destino.slug}/" 
                       style="display: inline-block; background-color: #0ea5e9; color: white; 
                              padding: 4px 8px; border-radius: 6px; text-decoration: none; 
                              font-size: 12px; font-weight: 600;">
                        Ver detalles
                    </a>
                </div>
            </div>
        </div>
        `;

        marker.bindPopup(popupContent);

        // Evento click para mostrar panel lateral
        marker.on('click', () => mostrarInfoPanel(destino));

        marker.addTo(markerLayer);
        markers.push(marker);
        bounds.push([lat, lng]);
    });

    document.getElementById('destinosCount').textContent = destinosFiltrados.length;

    if (bounds.length > 0) {
        map.fitBounds(bounds, { padding: [50, 50], maxZoom: 10 });
    }
}


    // ========================================
    // FILTRAR POR REGI√ìN
    // ========================================
    function filtrarPorRegion(region) {
        console.log(`üîç Filtrando por regi√≥n: ${region}`);
        regionActual = region;

        // Actualizar botones
        document.querySelectorAll('.region-filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        const btnActivo = document.querySelector(`[data-region="${region}"]`);
        if (btnActivo) {
            btnActivo.classList.add('active');
        }

        // Recrear marcadores
        crearMarcadores();

        // Cerrar panel de info
        cerrarInfoPanel();
    }



    // ========================================
    // OBTENER NOMBRE DE REGI√ìN
    // ========================================
    function getRegionName(region) {
        const nombres = {
            'costa': 'Costa',
            'sierra': 'Sierra',
            'oriente': 'Oriente',
            'galapagos': 'Gal√°pagos'
        };
        return nombres[region] || region;
    }

    // ========================================
    // EVENTOS
    // ========================================
    
    // Inicializar mapa cuando se cargue la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ P√°gina cargada, inicializando mapa...');
        
        // Verificar que tenemos datos
        if (destinosData.length === 0) {
            console.warn('‚ö†Ô∏è No hay destinos para mostrar');
            const loadingDiv = document.getElementById('mapLoading');
            loadingDiv.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-map-marked-alt text-gray-400 text-5xl mb-4"></i>
                    <p class="text-gray-900 font-semibold mb-2">No hay destinos disponibles</p>
                    <p class="text-gray-600 text-sm mb-4">Crea tu primer destino tur√≠stico</p>
                    {% if user.is_authenticated and user.es_administrador %}
                    <a href="{% url 'destinos:crear_destino' %}" class="inline-block px-6 py-3 bg-sky-600 text-white rounded-lg hover:bg-sky-700 font-semibold">
                        <i class="fas fa-plus mr-2"></i>
                        Crear destino
                    </a>
                    {% endif %}
                </div>
            `;
            return;
        }
        
        initMap();
    });

    // Cerrar panel al hacer clic fuera
    document.addEventListener('click', (e) => {
        const panel = document.getElementById('infoPanel');
        if (panel && !panel.contains(e.target) && !e.target.closest('.leaflet-container')) {
            if (!e.target.closest('button[data-region]')) {
                cerrarInfoPanel();
            }
        }
    });
</script>

{% endblock %}
