<div id="mapContainer" class="rounded-xl overflow-hidden shadow-lg border-2 border-gray-200 mb-4" style="height: 400px;">
    <div id="map" style="height: 100%; width: 100%;"></div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
      crossorigin=""/>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<script>
// Mapa de solo lectura para vista de detalle
let mapaDetalle = null;
let markerDetalle = null;

function initMapDetalle() {
    if (typeof L === 'undefined') {
        setTimeout(initMapDetalle, 500);
        return;
    }

    const mapElement = document.getElementById('map');
    if (!mapElement || mapaDetalle) return;

    // ‚úÖ Coordenadas desde el contexto Django
    const lat = parseFloat('{{ servicio.latitud }}');
    const lng = parseFloat('{{ servicio.longitud }}');

    console.log('üó∫Ô∏è Inicializando mapa de detalle:', { lat, lng });

    // Validar coordenadas
    if (isNaN(lat) || isNaN(lng)) {
        console.error('‚ùå Coordenadas inv√°lidas:', { lat, lng });
        mapElement.innerHTML = `
            <div class="flex items-center justify-center h-full bg-red-50">
                <div class="text-center p-8">
                    <i class="fas fa-exclamation-triangle text-red-600 text-5xl mb-4"></i>
                    <p class="text-red-900 font-semibold text-lg">Coordenadas inv√°lidas</p>
                    <p class="text-red-700 text-sm mt-2">Lat: ${lat}, Lng: ${lng}</p>
                </div>
            </div>
        `;
        return;
    }

    // Validar rango de Ecuador
    if (lat < -5 || lat > 2 || lng < -92 || lng > -75) {
        console.error('‚ùå Coordenadas fuera de rango de Ecuador:', { lat, lng });
        mapElement.innerHTML = `
            <div class="flex items-center justify-center h-full bg-yellow-50">
                <div class="text-center p-8">
                    <i class="fas fa-map-marked-alt text-yellow-600 text-5xl mb-4"></i>
                    <p class="text-yellow-900 font-semibold text-lg">Ubicaci√≥n fuera de Ecuador</p>
                    <p class="text-yellow-700 text-sm mt-2">Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}</p>
                </div>
            </div>
        `;
        return;
    }

    // Crear mapa
    mapaDetalle = L.map('map', {
        center: [lat, lng],
        zoom: 15,
        scrollWheelZoom: false,
        dragging: true,
        zoomControl: true,
        attributionControl: true
    });

    // Agregar capa de tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19,
        minZoom: 5
    }).addTo(mapaDetalle);

    // Crear marcador personalizado
    const iconHtml = `
        <div style="position: relative;">
            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); 
                 border: 4px solid white; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); 
                 box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);">
                <div style="width: 12px; height: 12px; background: white; border-radius: 50%; 
                     position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(45deg);"></div>
            </div>
        </div>
    `;

    markerDetalle = L.marker([lat, lng], {
        draggable: false,
        icon: L.divIcon({
            className: 'custom-marker',
            html: iconHtml,
            iconSize: [40, 40],
            iconAnchor: [20, 40],
            popupAnchor: [0, -40]
        })
    }).addTo(mapaDetalle);

    // Contenido del popup
    const popupContent = `
        <div style="text-align: center; font-family: sans-serif; padding: 10px;">
            <div style="font-size: 16px; font-weight: bold; color: #0ea5e9; margin-bottom: 8px;">
                üìç {{ servicio.nombre }}
            </div>
            <div style="font-size: 13px; color: #64748b;">
                <strong>Direcci√≥n:</strong><br>
                {{ servicio.direccion }}
            </div>
            <div style="font-size: 12px; color: #94a3b8; margin-top: 6px;">
                Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}
            </div>
        </div>
    `;

    markerDetalle.bindPopup(popupContent, {
        maxWidth: 300,
        className: 'custom-popup'
    }).openPopup();

    // Forzar re-render del mapa
    setTimeout(() => {
        if (mapaDetalle) mapaDetalle.invalidateSize(true);
    }, 100);

    console.log('‚úÖ Mapa de detalle inicializado correctamente');
}

// Inicializar cuando el DOM est√© listo
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(initMapDetalle, 250);
    });
} else {
    setTimeout(initMapDetalle, 250);
}

// Re-renderizar en resize
window.addEventListener('resize', function() {
    if (mapaDetalle) {
        clearTimeout(window.mapResizeTimer);
        window.mapResizeTimer = setTimeout(() => {
            mapaDetalle.invalidateSize(true);
        }, 150);
    }
});

// Re-renderizar despu√©s de cargar la p√°gina
window.addEventListener('load', function() {
    [100, 300, 600].forEach(delay => {
        setTimeout(() => {
            if (mapaDetalle) mapaDetalle.invalidateSize(true);
        }, delay);
    });
});
</script>

<style>
#mapContainer {
    position: relative;
    display: block;
    width: 100%;
    min-height: 400px;
}

#map {
    height: 100%;
    width: 100%;
}

.leaflet-container {
    background: #e5e7eb;
    border-radius: 12px;
    z-index: 1;
}

.leaflet-popup-content-wrapper {
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
}

.custom-marker {
    background: transparent !important;
    border: none !important;
}

.leaflet-control-zoom {
    border: 2px solid rgba(0, 0, 0, 0.1) !important;
    border-radius: 12px !important;
    overflow: hidden !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
}

.leaflet-control-zoom a {
    width: 36px !important;
    height: 36px !important;
    line-height: 36px !important;
    font-size: 20px !important;
    transition: all 0.2s ease !important;
}

.leaflet-control-zoom a:hover {
    background: #0ea5e9 !important;
    color: white !important;
}
</style>