<!-- Mapa editable con Mapbox para formularios de servicios -->
<div class="lg:col-span-2">
    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
        Selecciona la ubicaci√≥n en el mapa <span class="text-red-500">*</span>
    </label>
    
    <!-- Mostrar coordenadas actuales -->
    <div class="mb-3 p-3 bg-blue-50 rounded-lg border border-blue-200 dark:border-blue-800">
        <div class="flex items-center justify-between text-sm flex-wrap gap-2">
            <div class="flex items-center space-x-4">
                <div>
                    <span class="font-semibold text-blue-900">Latitud:</span>
                    <span class="text-blue-700 dark:text-blue-300 font-mono" id="displayLatitud">
                        {{ servicio.latitud|default:'-0.1807' }}
                    </span>
                </div>
                <div>
                    <span class="font-semibold text-blue-900">Longitud:</span>
                    <span class="text-blue-700 dark:text-blue-300 font-mono" id="displayLongitud">
                        {{ servicio.longitud|default:'-78.4678' }}
                    </span>
                </div>
            </div>
            <button type="button" 
                    onclick="sincronizarMapa()" 
                    class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded-lg transition-colors">
                <i class="fas fa-sync-alt mr-1"></i> Actualizar mapa
            </button>
        </div>
    </div>
    
    <!-- Mapa -->
    <div id="mapContainer" style="height: 400px; width: 100%; position: relative; overflow: hidden;" class="rounded-xl shadow-lg border-2 border-gray-200 dark:border-gray-700">
        <div id="map" style="height: 100%; width: 100%;"></div>
    </div>
    
    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
        <i class="fas fa-hand-pointer mr-1"></i>
        Haz clic en el mapa para colocar el marcador o arr√°stralo para ajustar la ubicaci√≥n
    </p>
</div>

<!-- Mapbox GL JS -->
<script src='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css' rel='stylesheet' />

<script>
let map = null;
let marker = null;
let mapInitialized = false;

// Configurar token de Mapbox
mapboxgl.accessToken = 'pk.eyJ1IjoiaW5ncG9sbGl0byIsImEiOiJjbWh4cmVwcHYwNDF2MnJvcGc5N3VocDliIn0.FDbD09-VTzE7H-HAfee0yg';

function updateDisplayCoords(lat, lng) {
    const displayLat = document.getElementById('displayLatitud');
    const displayLng = document.getElementById('displayLongitud');
    
    if (displayLat) displayLat.textContent = lat.toFixed(8);
    if (displayLng) displayLng.textContent = lng.toFixed(8);
}

function initMap() {
    try {
        if (typeof mapboxgl === 'undefined') {
            console.log('‚è≥ Esperando Mapbox...');
            setTimeout(initMap, 500);
            return;
        }

        if (mapInitialized && map) {
            map.resize();
            return;
        }

        const mapElement = document.getElementById('map');
        if (!mapElement) {
            console.error('‚ùå Elemento #map no encontrado');
            return;
        }

        // Buscar inputs de coordenadas
        const latInput = document.getElementById('latitud');
        const lngInput = document.getElementById('longitud');
        
        if (!latInput || !lngInput) {
            console.error('‚ùå CR√çTICO: No se encontraron inputs #latitud o #longitud');
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    title: '‚ö†Ô∏è Error Cr√≠tico',
                    html: `
                        <div class="text-left">
                            <p class="mb-3">Los campos de latitud y longitud no est√°n en el formulario.</p>
                            <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded text-xs font-mono">
                                &lt;input id="latitud" name="latitud"&gt;<br>
                                &lt;input id="longitud" name="longitud"&gt;
                            </div>
                        </div>
                    `,
                    icon: 'error',
                    confirmButtonText: 'Entendido',
                    confirmButtonColor: '#dc2626'
                });
            }
            return;
        }
        
        let initialLat = parseFloat(latInput.value);
        let initialLng = parseFloat(lngInput.value);
        
        // Validar coordenadas iniciales
        if (isNaN(initialLat) || isNaN(initialLng)) {
            console.warn('‚ö†Ô∏è Coordenadas inv√°lidas, usando centro de Ecuador');
            initialLat = -0.1807;
            initialLng = -78.4678;
        }
        
        console.log('üó∫Ô∏è Inicializando mapa con coordenadas:', { lat: initialLat, lng: initialLng });
        
        const isDefaultLocation = (Math.abs(initialLat + 0.1807) < 0.01 && Math.abs(initialLng + 78.4678) < 0.01);
        const initialZoom = isDefaultLocation ? 5 : 13;
        
        map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12',
            center: [initialLng, initialLat],
            zoom: initialZoom
        });
        
        map.addControl(new mapboxgl.NavigationControl());
        
        mapInitialized = true;
        
        // Si ya tiene coordenadas, colocar marcador
        if (!isDefaultLocation) {
            console.log('üéØ Colocando marcador en ubicaci√≥n guardada');
            setTimeout(() => updateMarker(initialLat, initialLng), 500);
        }
        
        // Evento click en el mapa
        map.on('click', function(e) {
            const lat = e.lngLat.lat;
            const lng = e.lngLat.lng;
            
            console.log('üñ±Ô∏è Click en mapa:', { lat, lng });
            
            // Validar rango de Ecuador
            if (lat < -5 || lat > 2 || lng < -92 || lng > -75) {
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        title: '‚ö†Ô∏è Ubicaci√≥n fuera de Ecuador',
                        html: `
                            <div class="text-left">
                                <p class="mb-3">La ubicaci√≥n debe estar dentro de Ecuador.</p>
                                <div class="bg-yellow-50 border-l-4 border-yellow-500 p-3 mb-3">
                                    <p class="font-semibold text-yellow-800 dark:text-yellow-200 mb-2">Rangos v√°lidos:</p>
                                    <ul class="text-sm text-yellow-700 dark:text-yellow-300 space-y-1">
                                        <li>‚Ä¢ Latitud: <strong>-5¬∞ a 2¬∞</strong></li>
                                        <li>‚Ä¢ Longitud: <strong>-92¬∞ a -75¬∞</strong></li>
                                    </ul>
                                </div>
                            </div>
                        `,
                        icon: 'warning',
                        confirmButtonText: 'Entendido',
                        confirmButtonColor: '#3b82f6'
                    });
                }
                return;
            }
            
            updateMarker(lat, lng);
        });
        
        console.log('‚úÖ Mapa inicializado correctamente');
        
    } catch (error) {
        console.error('‚ùå Error al inicializar mapa:', error);
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                title: 'Error al inicializar el mapa',
                text: error.message,
                icon: 'error',
                confirmButtonText: 'Entendido',
                confirmButtonColor: '#dc2626'
            });
        }
        mapInitialized = false;
    }
}

function updateMarker(lat, lng) {
    if (!map) {
        console.error('‚ùå Mapa no inicializado');
        return;
    }
    
    console.log('üìç Actualizando marcador a:', { lat, lng });
    
    const latInput = document.getElementById('latitud');
    const lngInput = document.getElementById('longitud');
    
    if (!latInput || !lngInput) {
        console.error('‚ùå CR√çTICO: Inputs de coordenadas no encontrados al actualizar marcador');
        return;
    }
    
    // Actualizar los inputs del formulario
    latInput.value = lat.toFixed(8);
    lngInput.value = lng.toFixed(8);
    
    // Actualizar el display visual
    updateDisplayCoords(lat, lng);
    
    // Eliminar marcador anterior
    if (marker) {
        marker.remove();
        marker = null;
    }
    
    // Crear nuevo marcador
    marker = new mapboxgl.Marker({
        draggable: true,
        color: '#ef4444'
    })
    .setLngLat([lng, lat])
    .addTo(map);
    
    const popupContent = `
        <div style="text-align: center; font-family: sans-serif; padding: 10px;">
            <div style="font-size: 16px; font-weight: bold; color: #0ea5e9; margin-bottom: 8px;">
                üìç Ubicaci√≥n del Servicio
            </div>
            <div style="font-size: 13px; color: #64748b;">
                <strong>Latitud:</strong> ${lat.toFixed(6)}<br>
                <strong>Longitud:</strong> ${lng.toFixed(6)}
            </div>
            <div style="margin-top: 8px; font-size: 11px; color: #94a3b8;">
                ‚úã Puedes arrastrar el marcador
            </div>
        </div>
    `;
    
    const popup = new mapboxgl.Popup({ offset: 25 })
        .setHTML(popupContent);
    marker.setPopup(popup).togglePopup();
    
    // Evento cuando arrastran el marcador
    marker.on('dragend', function() {
        const pos = marker.getLngLat();
        const newLat = pos.lat;
        const newLng = pos.lng;
        
        console.log('üîÑ Marcador arrastrado a:', { lat: newLat, lng: newLng });
        
        // Actualizar inputs
        if (latInput) latInput.value = newLat.toFixed(8);
        if (lngInput) lngInput.value = newLng.toFixed(8);
        
        // Actualizar display
        updateDisplayCoords(newLat, newLng);
        
        // Actualizar popup
        marker.getPopup().setHTML(`
            <div style="text-align: center; font-family: sans-serif; padding: 10px;">
                <div style="font-size: 16px; font-weight: bold; color: #0ea5e9; margin-bottom: 8px;">
                    üìç Ubicaci√≥n del Servicio
                </div>
                <div style="font-size: 13px; color: #64748b;">
                    <strong>Latitud:</strong> ${newLat.toFixed(6)}<br>
                    <strong>Longitud:</strong> ${newLng.toFixed(6)}
                </div>
            </div>
        `);
    });
    
    // Centrar mapa en el marcador
    map.flyTo({ center: [lng, lat], zoom: 15 });
    
    console.log('‚úÖ Marcador colocado correctamente');
}

async function sincronizarMapa() {
    const latInput = document.getElementById('latitud');
    const lngInput = document.getElementById('longitud');
    
    if (!latInput || !lngInput) {
        console.error('‚ö†Ô∏è No se encontraron inputs de latitud/longitud');
        return;
    }
    
    const lat = parseFloat(latInput.value);
    const lng = parseFloat(lngInput.value);
    
    if (isNaN(lat) || isNaN(lng)) {
        if (typeof Swal !== 'undefined') {
            await Swal.fire({
                title: '‚ö†Ô∏è Coordenadas inv√°lidas',
                text: 'Por favor ingresa n√∫meros v√°lidos para latitud y longitud',
                icon: 'warning',
                confirmButtonText: 'Entendido',
                confirmButtonColor: '#f59e0b'
            });
        }
        return;
    }
    
    updateMarker(lat, lng);
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Iniciando carga del mapa...');
    
    const latInput = document.getElementById('latitud');
    const lngInput = document.getElementById('longitud');
    
    // Event listeners para sincronizar cuando presionen Enter
    if (latInput) {
        latInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                sincronizarMapa();
            }
        });
    }
    if (lngInput) {
        lngInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                sincronizarMapa();
            }
        });
    }
    
    setTimeout(() => {
        initMap();
        
        // Si ya tiene coordenadas, mostrar marcador
        if (latInput && lngInput) {
            const lat = parseFloat(latInput.value);
            const lng = parseFloat(lngInput.value);
            
            if (!isNaN(lat) && !isNaN(lng)) {
                if (Math.abs(lat + 0.1807) > 0.01 || Math.abs(lng + 78.4678) > 0.01) {
                    setTimeout(() => updateMarker(lat, lng), 1000);
                }
            }
        }
    }, 250);
});

window.addEventListener('load', function() {
    const resizes = [100, 300, 600, 1000];
    resizes.forEach(delay => {
        setTimeout(() => {
            if (map) map.resize();
        }, delay);
    });
});

let resizeTimer;
window.addEventListener('resize', function() {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
        if (map) map.resize();
    }, 150);
});

console.log('‚úÖ Script del mapa cargado correctamente');
</script>

<style>
#mapContainer {
    position: relative;
    display: block;
    width: 100%;
    height: 400px;
    min-height: 400px;
    max-height: 400px;
    overflow: hidden;
    z-index: 1;
}

#map {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100% !important;
    height: 100% !important;
    z-index: 1;
}

.mapboxgl-map {
    width: 100% !important;
    height: 100% !important;
    background: #e5e7eb !important;
}

.mapboxgl-popup-content {
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    padding: 0;
}

.mapboxgl-ctrl-group {
    border-radius: 12px !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
}
</style>