{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Ecuador Turismo - Descubre lo Extraordinario{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/media/logo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/media/logo.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/media/logo.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#0052A3',
                        'primary-dark': '#003875',
                        'primary-light': '#4A90E2',
                    }
                }
            }
        }
    </script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/base-styles.css' %}">
    <link rel="stylesheet" href="{% static 'css/animations.css' %}">
    <link rel="stylesheet" href="{% static 'css/scrollbar.css' %}">
    <link rel="stylesheet" href="{% static 'css/loader.css' %}">
    <link rel="stylesheet" href="{% static 'css/chatbot-base.css' %}">
    <link rel="stylesheet" href="{% static 'css/chatbot-responsive.css' %}">
    <link rel="stylesheet" href="{% static 'css/chatbot-typing.css' %}">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Script para cargar el tema antes de renderizar -->
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'light';
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            }
        })();

        function actualizarContadorCarrito() {
            fetch('{% url "reservas:carrito_count" %}')
                .then(response => response.json())
                .then(data => {
                    const contador = document.getElementById('carritoCount');
                    if (contador) {
                        contador.textContent = data.count;
                        if (data.count > 0) {
                            contador.classList.add('animate-pulse');
                        } else {
                            contador.classList.remove('animate-pulse');
                        }
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function actualizarContadorReservas() {
            fetch('{% url "reservas:reservas_pendientes_count" %}')
                .then(response => response.json())
                .then(data => {
                    const contador = document.getElementById('reservasCount');
                    if (contador) {
                        contador.textContent = data.count;
                        if (data.count > 0) {
                            contador.classList.add('animate-pulse');
                        } else {
                            contador.classList.remove('animate-pulse');
                        }
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        document.addEventListener('DOMContentLoaded', function() {
            actualizarContadorCarrito();
            actualizarContadorReservas();
        });

        setInterval(actualizarContadorCarrito, 60000);
        setInterval(actualizarContadorReservas, 60000);
    </script>


    
    {% block extra_css %}{% endblock %}
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-200">

    <script>
        window.CSRF_TOKEN = '{{ csrf_token }}';
        window.chatbotUserInitial = '{{ user.nombre|slice:":1"|upper }}';
    </script>

    <div class="loader-overlay" id="loaderOverlay">
        <div class="loader-container">
            <div class="loader-ecuador">
                <div class="loader-ring"></div>
                <div class="loader-ring"></div>
                <div class="loader-ring"></div>
                <div class="loader-logo">
                    <img src="/media/logo.png" alt="Ecuador Turismo" 
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="loader-logo-fallback">ET</div>
                </div>
            </div>
            <div class="loader-text">Cargando...</div>
        </div>
    </div>
    
    <header class="bg-white/80 dark:bg-gray-800/90 backdrop-blur-sm shadow-md sticky top-0 z-50 border-b border-gray-200/50 dark:border-gray-700/50 transition-colors duration-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-3">
                <a href="{% url 'home' %}" class="flex items-center space-x-2 cursor-pointer hover:opacity-90 transition group">
                    <img src="/media/logo.png" alt="Ecuador Turismo Logo" class="h-12 w-auto group-hover:scale-105 transition-transform duration-300" 
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="w-10 h-10 gradient-bg rounded-lg items-center justify-center text-white text-xl font-bold shadow-lg group-hover:shadow-xl transition-all duration-300" style="display: none;">ET</div>
                    <div>
                        <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-sky-500 dark:from-blue-400 dark:to-sky-300">Ecuador Turismo</h1>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Descubre lo Extraordinario</p>
                    </div>
                </a>
                
                <nav class="hidden md:flex items-center space-x-2">
                    <a href="{% url 'home' %}" class="text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-gray-700/50 transition-all duration-300 font-medium px-4 py-2 rounded-lg group">
                        <i class="fas fa-home mr-2 group-hover:scale-110 transform transition-transform"></i>Inicio
                    </a>
                    <a href="{% url 'destinos:lista_destinos' %}" class="text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-gray-700/50 transition-all duration-300 font-medium px-4 py-2 rounded-lg group">
                        <i class="fas fa-map-marked-alt mr-2 group-hover:scale-110 transform transition-transform"></i>Destinos
                    </a>
                    <a href="{% url 'servicios:listar_servicios' %}" class="text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-gray-700/50 transition-all duration-300 font-medium px-4 py-2 rounded-lg group">
                        <i class="fas fa-concierge-bell mr-2 group-hover:scale-110 transform transition-transform"></i>Servicios
                    </a>
                    <a href="{% url 'rutas:crear_ruta' %}" class="text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-gray-700/50 transition-all duration-300 font-medium px-4 py-2 rounded-lg group">
                        <i class="fas fa-route mr-2 group-hover:scale-110 transform transition-transform"></i>Rutas
                    </a>

                    <!-- Separador -->
                    <div class="w-px h-6 bg-gray-200 dark:bg-gray-700/50"></div>

                    {% if user.is_authenticated %}
                        {% if user.rol.nombre == 'turista' %}
                            <a href="{% url 'reservas:ver_carrito' %}" class="relative p-2 hover:bg-blue-50 dark:hover:bg-gray-700/50 rounded-lg transition-all duration-300 group">
                                <i class="fas fa-shopping-cart text-xl text-gray-700 dark:text-gray-300 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-all"></i>
                                <span id="carritoCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center group-hover:scale-110 transition-transform">0</span>
                            </a>
                        {% elif user.rol.nombre == 'proveedor' %}
                            <a href="{% url 'reservas:reservas_proveedor' %}" class="relative p-2 hover:bg-blue-50 dark:hover:bg-gray-700/50 rounded-lg transition-all duration-300 group" title="Reservas pendientes">
                                <i class="fas fa-calendar-alt text-xl text-gray-700 dark:text-gray-300 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-all"></i>
                                <span id="reservasCount" class="absolute -top-1 -right-1 bg-yellow-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center group-hover:scale-110 transition-transform">0</span>
                            </a>
                        {% endif %}
                    {% endif %}

                    <!-- Botón de modo oscuro -->
                    <button onclick="toggleDarkMode()" class="p-2 hover:bg-blue-50 dark:hover:bg-gray-700/50 rounded-lg transition-all duration-300 group" title="Cambiar tema">
                        <i class="fas fa-moon text-gray-700 dark:text-gray-300 text-lg dark:hidden group-hover:text-blue-600 group-hover:rotate-12 transform transition-all"></i>
                        <i class="fas fa-sun text-amber-400 text-lg hidden dark:inline group-hover:text-amber-300 group-hover:rotate-12 transform transition-all"></i>
                    </button>
                    
                    {% if user.is_authenticated %}
                        <div class="relative ml-3" x-data="{ open: false }">
                            <button @click="open = !open" class="flex items-center space-x-2 px-3 py-2 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700/50 transition-all duration-300 group">
                                <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-sky-400 dark:from-blue-600 dark:to-sky-500 rounded-full flex items-center justify-center text-white font-semibold text-sm shadow-md group-hover:shadow-lg transition-all">
                                    {{ user.nombre|slice:":1"|upper }}
                                </div>
                                <span class="text-gray-700 dark:text-gray-300 font-medium text-sm group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">{{ user.nombre|truncatewords:2 }}</span>
                                <i class="fas fa-chevron-down text-xs text-gray-400 dark:text-gray-500"></i>
                            </button>

                            <div x-show="open" @click.away="open = false" x-transition class="absolute right-0 mt-2 w-64 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 py-1 slide-down">
                                <div class="px-4 py-3 border-b border-gray-100 dark:border-gray-700">
                                    <p class="text-sm font-semibold text-gray-900 dark:text-gray-100">{{ user.nombre }}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ user.correo }}</p>
                                    {% if user.rol %}
                                        <span class="inline-block mt-2 px-3 py-1 text-xs font-semibold rounded-full bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300">
                                            {% if user.rol.nombre == 'turista' %}<i class="fas fa-user mr-1"></i>Turista
                                            {% elif user.rol.nombre == 'proveedor' %}<i class="fas fa-briefcase mr-1"></i>Proveedor
                                            {% elif user.rol.nombre == 'administrador' %}<i class="fas fa-user-shield mr-1"></i>Administrador{% endif %}
                                        </span>
                                    {% endif %}
                                </div>

                                <a href="{% url 'usuarios:perfil' %}" class="flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                                    <i class="fas fa-user-circle mr-3 text-blue-600 dark:text-blue-400 w-4"></i>Mi Perfil
                                </a>
                                
                                {% if user.rol.nombre == 'turista' %}
                                    <a href="{% url 'reservas:mis_reservas' %}" class="flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                                        <i class="fas fa-calendar-check mr-3 text-blue-600 dark:text-blue-400 w-4"></i>Mis Reservas
                                    </a>
                                    <a href="{% url 'reservas:ver_carrito' %}" class="flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                                        <i class="fas fa-shopping-cart mr-3 text-blue-600 dark:text-blue-400 w-4"></i>Mi Carrito
                                    </a>
                                {% elif user.rol.nombre == 'proveedor' %}
                                    <a href="{% url 'servicios:mis_servicios' %}" class="flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                                        <i class="fas fa-briefcase mr-3 text-blue-600 dark:text-blue-400 w-4"></i>Mis Servicios
                                    </a>
                                {% elif user.rol.nombre == 'administrador' %}
                                    <a href="{% url 'usuarios:listar_usuarios' %}" class="flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                                        <i class="fas fa-users-cog mr-3 text-blue-600 dark:text-blue-400 w-4"></i>Gestión de Usuarios
                                    </a>
                                {% endif %}

                                <div class="border-t border-gray-100 dark:border-gray-700 my-1"></div>

                                <a href="{% url 'usuarios:logout' %}" class="flex items-center px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition">
                                    <i class="fas fa-sign-out-alt mr-3 w-4"></i>Cerrar Sesión
                                </a>
                            </div>
                        </div>
                    {% else %}
                        <a href="{% url 'usuarios:login' %}" class="ml-4 px-4 py-2 text-blue-700 dark:text-blue-400 border border-blue-700 dark:border-blue-400 rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900/20 transition font-medium">Iniciar Sesión</a>
                        <a href="{% url 'usuarios:register' %}" class="px-4 py-2 btn-primary text-white rounded-lg font-medium shadow-sm">Registrarse</a>
                    {% endif %}
                </nav>

                <div class="md:hidden flex items-center space-x-2">
                    <!-- Botón de modo oscuro móvil -->
                    <button onclick="toggleDarkMode()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition" title="Cambiar tema">
                        <i class="fas fa-moon text-gray-700 dark:text-gray-300 text-lg dark:hidden"></i>
                        <i class="fas fa-sun text-yellow-400 text-lg hidden dark:inline"></i>
                    </button>

                    <button onclick="toggleMobileMenu()" class="p-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div id="mobileMenu" class="hidden md:hidden bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 mobile-menu-enter">
            <div class="px-4 py-3 space-y-1">
                <a href="{% url 'home' %}" class="block py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg px-3 transition">
                    <i class="fas fa-home mr-2"></i>Inicio
                </a>
                <a href="{% url 'destinos:lista_destinos' %}" class="block py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg px-3 transition">
                    <i class="fas fa-map-marked-alt mr-2"></i>Destinos
                </a>
                <a href="{% url 'servicios:listar_servicios' %}" class="block py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg px-3 transition">
                    <i class="fas fa-concierge-bell mr-2"></i>Servicios
                </a>
                <a href="{% url 'destinos:mapa_destinos' %}" class="block py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg px-3 transition">
                    <i class="fas fa-route mr-2"></i>Rutas
                </a>
                
                {% if user.is_authenticated %}
                    {% if user.rol.nombre == 'turista' %}
                        <a href="{% url 'reservas:ver_carrito' %}" class="block py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg px-3 transition">
                            <i class="fas fa-shopping-cart mr-2"></i>Mi Carrito
                        </a>
                        <a href="{% url 'reservas:mis_reservas' %}" class="block py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg px-3 transition">
                            <i class="fas fa-calendar-check mr-2"></i>Mis Reservas
                        </a>
                    {% elif user.rol.nombre == 'proveedor' %}
                        <a href="{% url 'reservas:reservas_proveedor' %}" class="block py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg px-3 transition">
                            <i class="fas fa-calendar-alt mr-2"></i>Gestionar Reservas
                        </a>
                        <a href="{% url 'servicios:mis_servicios' %}" class="block py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg px-3 transition">
                            <i class="fas fa-briefcase mr-2"></i>Mis Servicios
                        </a>
                    {% elif user.rol.nombre == 'administrador' %}
                        <a href="{% url 'usuarios:listar_usuarios' %}" class="block py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg px-3 transition">
                            <i class="fas fa-users-cog mr-2"></i>Gestión de Usuarios
                        </a>
                    {% endif %}

                    <a href="{% url 'usuarios:perfil' %}" class="block py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg px-3 transition">
                        <i class="fas fa-user-circle mr-2"></i>Mi Perfil
                    </a>
                    <a href="{% url 'usuarios:logout' %}" class="block py-2 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg px-3 transition">
                        <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesión
                    </a>
                {% else %}
                    <a href="{% url 'usuarios:login' %}" class="block py-2 text-blue-700 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg px-3 transition font-medium">Iniciar Sesión</a>
                    <a href="{% url 'usuarios:register' %}" class="block py-2 gradient-bg text-white rounded-lg px-3 font-medium">Registrarse</a>
                {% endif %}
            </div>
        </div>
    </header>
    
    <main class="flex-grow">
        {% block content %}
            {# El contenido de las páginas hijas irá aquí #}
        {% endblock %}
    </main>
    
    <div class="chatbot-container">
        <div class="chatbot-button" onclick="toggleChatbot()" id="chatbotButton" title="Asistente Virtual">
            <img src="/media/bot.png" alt="Chatbot" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <i class="fas fa-robot" style="display: none;"></i>
            <span class="chatbot-badge" id="chatbotBadge" style="display: none;">1</span>
        </div>

        <div class="chatbot-window" id="chatbotWindow">
            <div class="chatbot-header">
                <div class="flex items-center space-x-3">
                    <img src="/media/bot.png" alt="Bot" class="w-10 h-10 rounded-full border-2 border-white object-cover" onerror="this.src='https://ui-avatars.com/api/?name=Bot&background=0052A3&color=fff&bold=true'">
                    <div>
                        <h3 class="font-semibold text-white">Asistente Virtual</h3>
                        <p class="text-xs text-blue-200">Ecuador Turismo</p>
                    </div>
                </div>
                <button onclick="toggleChatbot()" class="text-white hover:text-gray-200 transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="chatbot-messages" id="chatbotMessages"></div>

            <div class="chatbot-input-area">
                <div class="flex space-x-2">
                    <input type="text" id="chatbotInput" placeholder="Escribe tu mensaje..."
                           class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           onkeypress="handleChatKeyPress(event)">
                    <button onclick="sendChatMessage()" class="btn-primary text-white px-4 py-2 rounded-lg hover:opacity-90 transition">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="bg-gray-900 dark:bg-gray-900 text-white py-4 mt-auto border-t border-gray-700/50 dark:border-cyan-500/20 transition-colors">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col sm:flex-row items-center justify-between">
                <div class="flex items-center space-x-2 mb-2 sm:mb-0">
                    <img src="/media/logo.png" alt="Ecuador Turismo Logo" class="h-8 w-auto" 
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="w-8 h-8 gradient-bg rounded-lg items-center justify-center text-white text-sm font-bold shadow-md" style="display: none;">ET</div>

                    <div class="flex items-center space-x-2 divide-x divide-gray-700">
                        <span class="text-sm font-medium text-gray-300">&copy; 2025 Ecuador Turismo</span>
                        <span class="text-xs text-gray-400 pl-2">Todos los derechos reservados</span>
                    </div>
                </div>
                
                <p class="text-xs text-gray-500 dark:text-gray-400">
                    <i class="fas fa-graduation-cap text-xs mr-1"></i>
                    Proyecto Académico - UNEMI
                </p>
            </div>
        </div>
    </footer>

    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Chatbot Scripts -->
    <script src="{% static 'js/chatbot/chatbot-config.js' %}"></script>
    <script src="{% static 'js/chatbot/chatbot-utils.js' %}"></script>
    <script src="{% static 'js/chatbot/chatbot-core.js' %}"></script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>