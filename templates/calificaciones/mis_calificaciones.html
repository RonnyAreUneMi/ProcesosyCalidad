{% extends 'base.html' %}
{% load calificaciones_extras %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900">
    
    <!-- Header Section -->
    <div class="gradient-bg py-12" data-aos="fade-down">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-bold text-white mb-2">
                        Mis Calificaciones
                    </h1>
                    <p class="text-sky-100">Gestiona todas tus reseñas y opiniones</p>
                </div>
                <div class="hidden md:block">
                    <div class="w-16 h-16 bg-white dark:bg-gray-800 bg-opacity-20 backdrop-blur-custom rounded-2xl flex items-center justify-center">
                        <i class="fas fa-star text-white text-3xl"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 -mt-6 relative z-10">
        
        <!-- Statistics Dashboard -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" data-aos="fade-up">
            <!-- Total Calificaciones -->
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 card-hover border-l-4 border-sky-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">Total Reseñas</p>
                        <p class="text-3xl font-bold text-gray-900 dark:text-white">{{ total_calificaciones }}</p>
                    </div>
                    <div class="w-12 h-12 bg-sky-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-comment text-sky-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- Promedio -->
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 card-hover border-l-4 border-yellow-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">Tu Promedio</p>
                        <p class="text-3xl font-bold text-gray-900 dark:text-white">{{ promedio_calificaciones }}</p>
                    </div>
                    <div class="w-12 h-12 bg-yellow-100 dark:bg-yellow-900 rounded-lg flex items-center justify-center">
                        <i class="fas fa-star text-yellow-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- 5 Estrellas -->
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 card-hover border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">5 Estrellas</p>
                        <p class="text-3xl font-bold text-gray-900 dark:text-white">{{ distribucion.5 }}</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center">
                        <i class="fas fa-trophy text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- 1-2 Estrellas -->
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 card-hover border-l-4 border-red-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">Bajas (1-2★)</p>
                        <p class="text-3xl font-bold text-gray-900 dark:text-white">{{ distribucion.1|add:distribucion.2 }}</p>
                    </div>
                    <div class="w-12 h-12 bg-red-100 dark:bg-red-900 rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-line text-red-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de Calificaciones -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8" data-aos="fade-up">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <div class="w-10 h-10 gradient-bg rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-list text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white">Historial de Reseñas</h3>
                </div>
                <span class="text-sm text-gray-600 dark:text-gray-300">
                    Mostrando {{ page_obj.start_index }}-{{ page_obj.end_index }} de {{ page_obj.paginator.count }}
                </span>
            </div>

            <div class="space-y-4">
                {% for calificacion in page_obj %}
                <div class="border border-gray-200 dark:border-gray-700 rounded-xl p-5 hover:shadow-md transition-all">
                    <div class="flex items-start gap-4">
                        <!-- Imagen del Servicio -->
                        <a href="{% url 'servicios:detalle_servicio' calificacion.servicio.id %}" class="flex-shrink-0">
                            {% if calificacion.servicio.imagenes.first %}
                            <img src="{{ calificacion.servicio.imagenes.first.imagen.url }}" 
                                 class="w-24 h-24 rounded-lg object-cover" 
                                 alt="{{ calificacion.servicio.nombre }}">
                            {% else %}
                            <div class="w-24 h-24 bg-gradient-to-br from-sky-400 to-blue-500 rounded-lg flex items-center justify-center">
                                <i class="fas fa-image text-white text-2xl"></i>
                            </div>
                            {% endif %}
                        </a>

                        <!-- Contenido -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex-1">
                                    <a href="{% url 'servicios:detalle_servicio' calificacion.servicio.id %}" 
                                       class="text-lg font-bold text-gray-900 dark:text-white hover:text-sky-600 transition-colors">
                                        {{ calificacion.servicio.nombre }}
                                    </a>
                                    <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">
                                        <i class="fas fa-location-dot mr-1"></i>
                                        {{ calificacion.servicio.destino.nombre }}
                                    </p>
                                </div>
                                
                                <!-- Acciones -->
                                <div class="flex items-center space-x-2 ml-4">
                                    {% if calificacion.activo %}
                                    <span class="px-3 py-1 bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 rounded-full text-xs font-semibold">
                                        <i class="fas fa-check-circle mr-1"></i>
                                        Publicada
                                    </span>
                                    {% else %}
                                    <span class="px-3 py-1 bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300 rounded-full text-xs font-semibold">
                                        <i class="fas fa-clock mr-1"></i>
                                        En revisión
                                    </span>
                                    {% endif %}
                                    
                                    <a href="{% url 'calificaciones:editar_calificacion' calificacion.id %}" 
                                       class="p-2 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg transition-colors"
                                       title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button onclick="confirmarEliminar({{ calificacion.id }}, '{{ calificacion.servicio.nombre|escapejs }}')"
                                            class="p-2 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"
                                            title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Rating y Fecha -->
                            <div class="flex items-center space-x-4 mb-3">
                                <div class="flex items-center">
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= calificacion.puntuacion %}
                                        <i class="fas fa-star text-yellow-400"></i>
                                        {% else %}
                                        <i class="far fa-star text-yellow-400"></i>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                <span class="text-sm text-gray-500 dark:text-gray-400">
                                    <i class="far fa-calendar mr-1"></i>
                                    {{ calificacion.fecha_creacion|date:"d M Y" }}
                                </span>
                            </div>

                            <!-- Comentario -->
                            {% if calificacion.comentario %}
                            <p class="text-gray-700 dark:text-gray-300 text-sm mb-3 line-clamp-2">
                                {{ calificacion.comentario }}
                            </p>
                            {% else %}
                            <p class="text-gray-400 italic text-sm mb-3">Sin comentario</p>
                            {% endif %}

                            <!-- Respuesta del Proveedor -->
                            {% if calificacion.respuesta %}
                            <div class="bg-sky-50 rounded-lg p-3 border-l-4 border-sky-500">
                                <div class="flex items-start space-x-2">
                                    <i class="fas fa-reply text-sky-600 mt-1"></i>
                                    <div class="flex-1">
                                        <p class="text-xs font-semibold text-sky-900 mb-1">Respuesta del proveedor:</p>
                                        <p class="text-sm text-sky-800">{{ calificacion.respuesta.respuesta }}</p>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-16">
                    <div class="w-20 h-20 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-comment-slash text-gray-400 dark:text-gray-500 text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-2">No tienes calificaciones aún</h3>
                    <p class="text-gray-500 dark:text-gray-400 mb-6">Comparte tu experiencia sobre los servicios que has usado</p>
                    <a href="{% url 'servicios:listar_servicios' %}" 
                       class="inline-flex items-center px-6 py-3 btn-primary text-white rounded-lg font-semibold hover:shadow-lg transition-all">
                        <i class="fas fa-search mr-2"></i>
                        Explorar Servicios
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="flex items-center justify-center mb-8" data-aos="fade-up">
            <nav class="inline-flex rounded-lg shadow-sm" aria-label="Paginación">
                {% if page_obj.has_previous %}
                <a href="?page=1" 
                   class="relative inline-flex items-center px-3 py-2 rounded-l-lg border border-gray-300 bg-white dark:bg-gray-800 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:bg-gray-900 transition-colors">
                    <i class="fas fa-angle-double-left"></i>
                </a>
                <a href="?page={{ page_obj.previous_page_number }}" 
                   class="relative inline-flex items-center px-3 py-2 border-t border-b border-gray-300 bg-white dark:bg-gray-800 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:bg-gray-900 transition-colors">
                    <i class="fas fa-angle-left"></i>
                </a>
                {% else %}
                <span class="relative inline-flex items-center px-3 py-2 rounded-l-lg border border-gray-300 bg-gray-100 dark:bg-gray-700 text-sm font-medium text-gray-400 cursor-not-allowed">
                    <i class="fas fa-angle-double-left"></i>
                </span>
                <span class="relative inline-flex items-center px-3 py-2 border-t border-b border-gray-300 bg-gray-100 dark:bg-gray-700 text-sm font-medium text-gray-400 cursor-not-allowed">
                    <i class="fas fa-angle-left"></i>
                </span>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                    <span class="relative inline-flex items-center px-4 py-2 border border-sky-500 bg-sky-500 text-sm font-semibold text-white">
                        {{ num }}
                    </span>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <a href="?page={{ num }}" 
                       class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white dark:bg-gray-800 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:bg-gray-900 transition-colors">
                        {{ num }}
                    </a>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}" 
                   class="relative inline-flex items-center px-3 py-2 border-t border-b border-gray-300 bg-white dark:bg-gray-800 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:bg-gray-900 transition-colors">
                    <i class="fas fa-angle-right"></i>
                </a>
                <a href="?page={{ page_obj.paginator.num_pages }}" 
                   class="relative inline-flex items-center px-3 py-2 rounded-r-lg border border-gray-300 bg-white dark:bg-gray-800 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:bg-gray-900 transition-colors">
                    <i class="fas fa-angle-double-right"></i>
                </a>
                {% else %}
                <span class="relative inline-flex items-center px-3 py-2 border-t border-b border-gray-300 bg-gray-100 dark:bg-gray-700 text-sm font-medium text-gray-400 cursor-not-allowed">
                    <i class="fas fa-angle-right"></i>
                </span>
                <span class="relative inline-flex items-center px-3 py-2 rounded-r-lg border border-gray-300 bg-gray-100 dark:bg-gray-700 text-sm font-medium text-gray-400 cursor-not-allowed">
                    <i class="fas fa-angle-double-right"></i>
                </span>
                {% endif %}
            </nav>
        </div>
        {% endif %}

    </div>
</div>

<!-- Modal de Confirmación de Eliminación -->
<div id="modalEliminar" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full p-6" data-aos="zoom-in">
        <div class="text-center mb-6">
            <div class="w-16 h-16 bg-red-100 dark:bg-red-900 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">¿Eliminar calificación?</h3>
            <p class="text-gray-600 dark:text-gray-300" id="mensajeEliminar"></p>
        </div>
        
        <form id="formEliminar" method="post" action="">
            {% csrf_token %}
            <div class="flex space-x-3">
                <button type="button" 
                        onclick="cerrarModalEliminar()"
                        class="flex-1 px-4 py-3 border border-gray-300 rounded-lg font-semibold text-gray-700 hover:bg-gray-50 dark:bg-gray-900 transition-colors">
                    Cancelar
                </button>
                <button type="submit" 
                        class="flex-1 px-4 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors">
                    Sí, eliminar
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function confirmarEliminar(id, nombre) {
    const modal = document.getElementById('modalEliminar');
    const form = document.getElementById('formEliminar');
    const mensaje = document.getElementById('mensajeEliminar');
    
    mensaje.textContent = `¿Estás seguro de eliminar tu reseña de "${nombre}"?`;
    form.action = `/calificaciones/eliminar/${id}/`;
    
    modal.classList.remove('hidden');
}

function cerrarModalEliminar() {
    document.getElementById('modalEliminar').classList.add('hidden');
}

document.getElementById('modalEliminar').addEventListener('click', function(e) {
    if (e.target === this) {
        cerrarModalEliminar();
    }
});
</script>
{% endblock %}