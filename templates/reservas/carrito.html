{% extends 'base.html' %}
{% load calificaciones_extra %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Header del Carrito -->
        <div class="mb-8">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">
                        <i class="fas fa-shopping-cart mr-3 text-sky-600"></i>
                        Mi Carrito
                    </h1>
                    <p class="text-gray-600">
                        {% if cantidad_items > 0 %}
                            Tienes {{ cantidad_items }} servicio{{ cantidad_items|pluralize }} en tu carrito
                        {% else %}
                            Tu carrito está vacío
                        {% endif %}
                    </p>
                </div>
                
                {% if items %}
                <div class="flex gap-3">
                    <a href="{% url 'servicios:listar_servicios' %}" 
                       class="px-4 py-2 border-2 border-gray-300 rounded-lg font-semibold text-gray-700 hover:bg-gray-50 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Seguir Comprando
                    </a>
                    <form method="post" action="{% url 'reservas:vaciar_carrito' %}" class="inline">
                        {% csrf_token %}
                        <button type="submit" 
                                onclick="return confirm('¿Estás seguro de vaciar el carrito?')"
                                class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-colors">
                            <i class="fas fa-trash-alt mr-2"></i>
                            Vaciar Carrito
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>

            <!-- Alerta de items expirando -->
            {% if items_expirando %}
            <div class="mt-4 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-yellow-600 text-xl mr-3"></i>
                    <div>
                        <p class="text-sm font-semibold text-yellow-900">Atención</p>
                        <p class="text-sm text-yellow-800">Algunos items llevan más de 24 horas en tu carrito. Te recomendamos confirmar tu reserva pronto.</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        {% if items %}
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Lista de Items -->
            <div class="lg:col-span-2 space-y-4">
                {% for item in items %}
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition-shadow">
                    <div class="p-6">
                        <div class="flex gap-4">
                            <!-- Imagen del Servicio -->
                            <div class="flex-shrink-0">
                                {% if item.servicio.imagenes.first %}
                                <img src="{{ item.servicio.imagenes.first.imagen.url }}" 
                                     alt="{{ item.servicio.nombre }}"
                                     class="w-32 h-32 rounded-lg object-cover">
                                {% else %}
                                <div class="w-32 h-32 bg-gradient-to-br from-sky-400 to-blue-500 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-image text-white text-3xl"></i>
                                </div>
                                {% endif %}
                            </div>

                            <!-- Información del Servicio -->
                            <div class="flex-1 min-w-0">
                                <div class="flex items-start justify-between mb-2">
                                    <div class="flex-1">
                                        <a href="{% url 'servicios:detalle_servicio' item.servicio.id %}" 
                                           class="text-xl font-bold text-gray-900 hover:text-sky-600 transition-colors">
                                            {{ item.servicio.nombre }}
                                        </a>
                                        
                                        <div class="flex flex-wrap items-center gap-3 mt-2">
                                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-purple-100 text-purple-800">
                                                {% if item.servicio.tipo == 'alojamiento' %}
                                                    <i class="fas fa-hotel mr-1"></i>
                                                {% elif item.servicio.tipo == 'tour' %}
                                                    <i class="fas fa-route mr-1"></i>
                                                {% elif item.servicio.tipo == 'actividad' %}
                                                    <i class="fas fa-hiking mr-1"></i>
                                                {% elif item.servicio.tipo == 'transporte' %}
                                                    <i class="fas fa-bus mr-1"></i>
                                                {% else %}
                                                    <i class="fas fa-utensils mr-1"></i>
                                                {% endif %}
                                                {{ item.servicio.get_tipo_display }}
                                            </span>
                                            
                                            <span class="text-sm text-gray-600">
                                                <i class="fas fa-location-dot mr-1 text-sky-600"></i>
                                                {{ item.servicio.destino.nombre }}
                                            </span>
                                            
                                            <div class="flex items-center text-sm text-gray-600">
                                                {% for i in "12345" %}
                                                    {% if forloop.counter <= item.servicio.calificacion_promedio %}
                                                    <i class="fas fa-star text-yellow-400 text-xs"></i>
                                                    {% else %}
                                                    <i class="far fa-star text-yellow-400 text-xs"></i>
                                                    {% endif %}
                                                {% endfor %}
                                                <span class="ml-1 font-semibold">{{ item.servicio.calificacion_promedio|floatformat:1 }}</span>
                                                <span class="ml-1 text-gray-500">({{ item.servicio.total_calificaciones }})</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Botón Eliminar -->
                                    <form method="post" action="{% url 'reservas:eliminar_item_carrito' item.id %}" class="ml-4">
                                        {% csrf_token %}
                                        <button type="submit" 
                                                onclick="return confirm('¿Eliminar este servicio del carrito?')"
                                                class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                                                title="Eliminar">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </form>
                                </div>

                                <!-- Detalles de la Reserva -->
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4 pt-4 border-t border-gray-200">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                                            <i class="fas fa-calendar-alt mr-1 text-sky-600"></i>
                                            Fecha del Servicio
                                        </label>
                                        <p class="text-gray-900 font-medium">{{ item.fecha_servicio|date:"d M Y" }}</p>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                                            <i class="fas fa-users mr-1 text-sky-600"></i>
                                            Cantidad de Personas
                                        </label>
                                        <form method="post" action="{% url 'reservas:actualizar_item_carrito' item.id %}" class="flex items-center gap-2">
                                            {% csrf_token %}
                                            <div class="flex items-center border border-gray-300 rounded-lg overflow-hidden">
                                                <button type="button" 
                                                        onclick="decrementar({{ item.id }})"
                                                        class="px-3 py-2 bg-gray-100 hover:bg-gray-200 transition-colors">
                                                    <i class="fas fa-minus text-sm"></i>
                                                </button>
                                                <input type="number" 
                                                       name="cantidad_personas" 
                                                       id="cantidad_{{ item.id }}"
                                                       value="{{ item.cantidad_personas }}"
                                                       min="1"
                                                       max="{{ item.servicio.capacidad_maxima }}"
                                                       class="w-16 text-center border-0 focus:ring-0 font-semibold"
                                                       readonly>
                                                <button type="button" 
                                                        onclick="incrementar({{ item.id }}, {{ item.servicio.capacidad_maxima }})"
                                                        class="px-3 py-2 bg-gray-100 hover:bg-gray-200 transition-colors">
                                                    <i class="fas fa-plus text-sm"></i>
                                                </button>
                                            </div>
                                            <button type="submit" 
                                                    class="px-4 py-2 bg-sky-600 hover:bg-sky-700 text-white rounded-lg text-sm font-semibold transition-colors">
                                                Actualizar
                                            </button>
                                        </form>
                                        <p class="text-xs text-gray-500 mt-1">Máx: {{ item.servicio.capacidad_maxima }} personas</p>
                                    </div>
                                </div>

                                <!-- Precios -->
                                <div class="mt-4 pt-4 border-t border-gray-200">
                                    <div class="flex items-center justify-between text-sm mb-2">
                                        <span class="text-gray-600">Precio unitario:</span>
                                        <span class="font-semibold text-gray-900">${{ item.servicio.precio|floatformat:2 }}</span>
                                    </div>
                                    <div class="flex items-center justify-between text-sm mb-2">
                                        <span class="text-gray-600">Subtotal ({{ item.cantidad_personas }} persona{{ item.cantidad_personas|pluralize }}):</span>
                                        <span class="font-semibold text-gray-900">${{ item.get_subtotal|floatformat:2 }}</span>
                                    </div>
                                    <div class="flex items-center justify-between text-sm mb-2">
                                        <span class="text-gray-600">Impuestos (12%):</span>
                                        <span class="font-semibold text-gray-900">${{ item.get_impuestos|floatformat:2 }}</span>
                                    </div>
                                    <div class="flex items-center justify-between pt-2 border-t border-gray-200">
                                        <span class="font-bold text-gray-900">Total:</span>
                                        <span class="text-xl font-bold text-sky-600">${{ item.get_total|floatformat:2 }}</span>
                                    </div>
                                </div>

                                <!-- Agregado al carrito hace -->
                                <div class="mt-3 text-xs text-gray-500">
                                    <i class="fas fa-clock mr-1"></i>
                                    Agregado {{ item.fecha_agregado|timesince }} atrás
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Resumen del Pedido -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 sticky top-4">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">
                        <i class="fas fa-receipt mr-2 text-sky-600"></i>
                        Resumen del Pedido
                    </h2>

                    <div class="space-y-4 mb-6">
                        <div class="flex items-center justify-between text-gray-700">
                            <span>Subtotal:</span>
                            <span class="font-semibold">${{ subtotal|floatformat:2 }}</span>
                        </div>
                        
                        <div class="flex items-center justify-between text-gray-700">
                            <span>Impuestos (12%):</span>
                            <span class="font-semibold">${{ impuestos|floatformat:2 }}</span>
                        </div>
                        
                        <div class="pt-4 border-t-2 border-gray-200">
                            <div class="flex items-center justify-between">
                                <span class="text-lg font-bold text-gray-900">Total:</span>
                                <span class="text-2xl font-bold text-sky-600">${{ total|floatformat:2 }}</span>
                            </div>
                        </div>
                    </div>

                    <form method="get" action="{% url 'reservas:confirmar_reserva' %}">
                        <button type="submit" 
                                class="w-full py-3 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white rounded-lg font-bold text-lg transition-all transform hover:scale-105 shadow-lg">
                            <i class="fas fa-check-circle mr-2"></i>
                            Confirmar Reserva
                        </button>
                    </form>

                    <div class="mt-6 pt-6 border-t border-gray-200 space-y-3">
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-shield-alt mr-3 text-green-600 text-lg"></i>
                            <span>Pago 100% seguro</span>
                        </div>
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-undo mr-3 text-blue-600 text-lg"></i>
                            <span>Cancelación gratis</span>
                        </div>
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-headset mr-3 text-purple-600 text-lg"></i>
                            <span>Soporte 24/7</span>
                        </div>
                    </div>

                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <p class="text-xs text-gray-500 leading-relaxed">
                            <i class="fas fa-info-circle mr-1"></i>
                            Al confirmar tu reserva aceptas nuestros términos y condiciones. 
                            Recibirás un correo de confirmación con los detalles.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        {% else %}
        <!-- Carrito Vacío -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-12 text-center">
            <div class="max-w-md mx-auto">
                <div class="w-32 h-32 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-shopping-cart text-gray-400 text-5xl"></i>
                </div>
                
                <h2 class="text-2xl font-bold text-gray-900 mb-3">Tu carrito está vacío</h2>
                <p class="text-gray-600 mb-8">Explora nuestros increíbles servicios y comienza a planificar tu próxima aventura</p>
                
                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                    <a href="{% url 'servicios:listar_servicios' %}" 
                       class="inline-flex items-center justify-center px-6 py-3 bg-sky-600 hover:bg-sky-700 text-white rounded-lg font-semibold transition-colors">
                        <i class="fas fa-compass mr-2"></i>
                        Explorar Servicios
                    </a>
                    <a href="{% url 'home' %}" 
                       class="inline-flex items-center justify-center px-6 py-3 border-2 border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg font-semibold transition-colors">
                        <i class="fas fa-home mr-2"></i>
                        Volver al Inicio
                    </a>
                </div>

                <!-- Servicios Destacados o Populares -->
                <div class="mt-12 text-left">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">
                        <i class="fas fa-fire mr-2 text-orange-500"></i>
                        Servicios Populares
                    </h3>
                    <p class="text-sm text-gray-500 mb-4">Descubre los servicios más reservados por nuestros usuarios</p>
                    
                    <!-- Aquí podrías mostrar 3-4 servicios populares -->
                    <a href="{% url 'servicios:listar_servicios' %}?orden=recientes" 
                       class="text-sky-600 hover:text-sky-700 font-semibold text-sm">
                        Ver todos los servicios →
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Sticky Bottom Bar (Mobile) -->
{% if items %}
<div class="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t-2 border-gray-200 p-4 z-40 shadow-lg">
    <div class="flex items-center justify-between mb-2">
        <div>
            <p class="text-xs text-gray-600">Total a pagar</p>
            <div class="flex items-baseline">
                <span class="text-2xl font-bold text-gray-900">${{ total|floatformat:2 }}</span>
                <span class="text-sm text-gray-500 ml-1">USD</span>
            </div>
        </div>
        <form method="get" action="{% url 'reservas:confirmar_reserva' %}" class="flex-1 ml-4">
            <button type="submit" 
                    class="w-full px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg font-bold text-base transition-colors">
                <i class="fas fa-check-circle mr-2"></i>
                Confirmar
            </button>
        </form>
    </div>
</div>
{% endif %}

<style>
/* Animaciones suaves */
.hover\:scale-105:hover {
    transform: scale(1.05);
}

/* Espacio para bottom bar en mobile */
@media (max-width: 1023px) {
    body {
        padding-bottom: 90px;
    }
}

/* Transiciones */
* {
    transition-duration: 200ms;
}

/* Input number sin flechas */
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

input[type="number"] {
    -moz-appearance: textfield;
}
</style>

<script>
// ====================================
// FUNCIONES DE CANTIDAD
// ====================================
function incrementar(itemId, max) {
    const input = document.getElementById(`cantidad_${itemId}`);
    const valorActual = parseInt(input.value);
    
    if (valorActual < max) {
        input.value = valorActual + 1;
    } else {
        mostrarNotificacion(`La capacidad máxima es ${max} personas`, 'warning');
    }
}

function decrementar(itemId) {
    const input = document.getElementById(`cantidad_${itemId}`);
    const valorActual = parseInt(input.value);
    
    if (valorActual > 1) {
        input.value = valorActual - 1;
    } else {
        mostrarNotificacion('La cantidad mínima es 1 persona', 'warning');
    }
}

// ====================================
// NOTIFICACIONES
// ====================================
function mostrarNotificacion(mensaje, tipo = 'info') {
    const colores = {
        'success': 'bg-green-500',
        'error': 'bg-red-500',
        'warning': 'bg-yellow-500',
        'info': 'bg-blue-500'
    };
    
    const iconos = {
        'success': 'fa-check-circle',
        'error': 'fa-exclamation-circle',
        'warning': 'fa-exclamation-triangle',
        'info': 'fa-info-circle'
    };
    
    const notif = document.createElement('div');
    notif.className = `fixed top-20 right-4 px-6 py-4 rounded-xl shadow-2xl z-50 ${colores[tipo]} text-white font-semibold transform transition-all duration-300`;
    notif.style.transform = 'translateX(400px)';
    notif.innerHTML = `
        <div class="flex items-center space-x-3">
            <i class="fas ${iconos[tipo]} text-xl"></i>
            <span>${mensaje}</span>
        </div>
    `;
    
    document.body.appendChild(notif);
    
    setTimeout(() => {
        notif.style.transform = 'translateX(0)';
    }, 10);
    
    setTimeout(() => {
        notif.style.transform = 'translateX(400px)';
        setTimeout(() => notif.remove(), 300);
    }, 3000);
}

// ====================================
// VALIDACIÓN ANTES DE CONFIRMAR
// ====================================
document.addEventListener('DOMContentLoaded', function() {
    // Prevenir envío múltiple
    const formsConfirmar = document.querySelectorAll('form[action*="confirmar"]');
    formsConfirmar.forEach(form => {
        form.addEventListener('submit', function(e) {
            const button = this.querySelector('button[type="submit"]');
            if (button.disabled) {
                e.preventDefault();
                return false;
            }
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Procesando...';
        });
    });
});
</script>
{% endblock %}